<!DOCTYPE html>
<html>
<head>
  <title>Heat-Wave Predictor (Joshi 2025)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #header {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 2px 0;
      background-color: #e1f7d5;
      border-bottom: 3px solid #1f77b4;
    }
    #header h1 {
      font-size: 24px;
      font-weight: bold;
      color: #1f77b4;
    }
    #controls {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    label {
      font-weight: bold;
    }
    select, input, button {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #1f77b4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #155a8a;
    }
    #result {
      margin-top: 10px;
      font-weight: bold;
      color: #444;
    }
    #heatmap, #heatwave-probability {
      width: 100%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
    }
    #download-btn {
      margin-top: 15px;
    }
    #forecast-date {
      font-style: italic;
      margin-top: -10px;
    }
    #research-info {
      position: relative;
      width: 100%;
      background-color: #e1f7d5;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    @media (max-width: 600px) {
      #research-info {
        width: 100%;
        padding: 10px;
        font-size: 14px;
      }
    }
    #research-info h3 {
      margin-top: 0;
    }
    #research-info a {
      color: #1f77b4;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Heat-Wave Predictor by Yash Joshi</h1>
  </div>

  <div id="research-info">
    <h3 style="padding-left: 30px;">Research Paper</h3>
    <p style="padding-left: 30px;">This tool is based on the study <strong>"Prediction of regional heat waves using Hybrid LSTM approach"</strong> by Yash Joshi et al. (M.Tech Project, IIT Bhubaneswar under Dr. SR Kannan).</p>
    <p style="padding-left: 30px;">Read the paper: <a href="https://drive.google.com/file/d/1237mQWaa4qvh7VelEPUmZhDkiCLnXcII/view?usp=sharing" target="_blank">Research Link</a></p>
  </div>

  <br>

  <div id="controls">
    <div>
      <label for="leadDay">Select Day Lead:</label>
      <select id="leadDay">
        <option value="1">Day 1</option>
        <option value="2">Day 2</option>
        <option value="3">Day 3</option>
      </select>
    </div>
    <div>
      <label for="lat">Latitude:</label>
      <input type="number" id="lat" step="0.01" placeholder="e.g., 20.75">
    </div>
    <div>
      <label for="lon">Longitude:</label>
      <input type="number" id="lon" step="0.01" placeholder="e.g., 84.25">
    </div>
    <button onclick="fetchSinglePointTemp()">Get Temp at Point</button>
    <div id="result"></div>
  </div>

  <div id="forecast-date"></div>
  <div id="loading-message" style="display: none; font-weight: bold; color: #1f77b4; margin-top: 10px;">
    Please wait, the model results are being loaded...
  </div>
  <div id="heatmap"></div>
  <div id="heatwave-probability"></div>
  <button id="download-btn" onclick="downloadCSV()">Download CSV</button>

  <script>
    const latStart = 19.0, latEnd = 22.0;
    const lonStart = 82.0, lonEnd = 86.0;
    const step = 0.25;
    let lats = [], lons = [], z = [], probZ = [];
    let currentLead = 0;
    let spatialAvg = 0;

    for (let lat = latStart; lat <= latEnd; lat += step) {
      lats.push(parseFloat(lat.toFixed(2)));
    }
    for (let lon = lonStart; lon <= lonEnd; lon += step) {
      lons.push(parseFloat(lon.toFixed(2)));
    }

    function updateForecastDate(lead) {
      const today = new Date();
      today.setDate(today.getDate() + lead);
      const forecastDate = today.toDateString();
      document.getElementById('forecast-date').textContent = `Forecast for: ${forecastDate}`;
    }

    function fetchHeatmapData(dayLead = 0) {
      currentLead = dayLead;
      updateForecastDate(dayLead);
      document.getElementById('loading-message').style.display = 'block';
      setTimeout(() => {
        document.getElementById('loading-message').style.display = 'none';
      }, 20000);

      z = Array.from({ length: lats.length }, () => Array(lons.length).fill(null));
      probZ = [];
      let total = lats.length * lons.length;
      let completed = 0;
      let tempSum = 0, count = 0;

      lats.forEach((lat, i) => {
        lons.forEach((lon, j) => {
          const url = `https://backend-heatwave.onrender.com/api/forecast?lat=${lat}&lon=${lon}&days=${dayLead + 1}`;

          fetch(url)
            .then(res => res.json())
            .then(data => {
              const temp = data?.data?.[dayLead]?.maxtemp_c ?? null;
              z[i][j] = temp;
              if (temp !== null) {
                tempSum += temp;
                count++;
              }
            })
            .catch(() => {
              z[i][j] = null;
            })
            .finally(() => {
              completed++;
              if (completed === total) {
                interpolateMissingValues();
                spatialAvg = tempSum / count;
                computeProbabilityMap();
                renderHeatmap();
                renderProbabilityContour();
              }
            });
        });
      });
    }

    function interpolateMissingValues() {
      for (let i = 0; i < lats.length; i++) {
        for (let j = 0; j < lons.length; j++) {
          if (z[i][j] === null) {
            let sum = 0, n = 0;
            const neighbors = [
              [i-1, j], [i+1, j],
              [i, j-1], [i, j+1],
              [i-1, j-1], [i-1, j+1],
              [i+1, j-1], [i+1, j+1]
            ];
            neighbors.forEach(([x, y]) => {
              if (x >= 0 && x < lats.length && y >= 0 && y < lons.length && z[x][y] !== null) {
                sum += z[x][y];
                n++;
              }
            });
            if (n > 0) {
              z[i][j] = sum / n;
            } else {
              z[i][j] = spatialAvg || 30; // fallback
            }
          }
        }
      }
    }

    function computeProbabilityMap() {
      probZ = [];
      for (let i = 0; i < lats.length; i++) {
        probZ[i] = [];
        for (let j = 0; j < lons.length; j++) {
          const temp = z[i][j];
          const deviation = temp - spatialAvg;
          const prob = 1 / (1 + Math.exp(-0.6 * deviation));
          probZ[i][j] = Math.round(prob * 100);
        }
      }
    }

    function renderHeatmap() {
      const data = [{
        z: z,
        x: lons,
        y: lats,
        type: 'heatmap',
        zsmooth: 'best',
        colorscale: 'YlOrRd',
        reversescale: true,
        colorbar: { title: '°C' }
      }];
      const layout = {
        xaxis: { title: 'Longitude' },
        yaxis: { title: 'Latitude' },
        title: 'Max Temperature Forecast'
      };
      Plotly.newPlot('heatmap', data, layout);
    }

    function renderProbabilityContour() {
      const data = [{
        z: probZ,
        x: lons,
        y: lats,
        type: 'contour',
        colorscale: 'Reds',
        contours: {
          coloring: 'heatmap',
          showlabels: true,
          labelfont: { size: 12, color: 'black' }
        },
        colorbar: { title: 'Probability (%)' }
      }];
      const layout = {
        xaxis: { title: 'Longitude' },
        yaxis: { title: 'Latitude' },
        title: 'Heatwave Probability (Deviation > 4.5°C)'
      };
      Plotly.newPlot('heatwave-probability', data, layout);
    }

    function fetchSinglePointTemp() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const lead = parseInt(document.getElementById('leadDay').value);

      if (isNaN(lat) || isNaN(lon)) {
        document.getElementById('result').textContent = 'Please enter valid coordinates.';
        return;
      }

      const url = `https://backend-heatwave.onrender.com/api/forecast?lat=${lat}&lon=${lon}&days=${lead + 1}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const temp = data?.data?.[lead]?.maxtemp_c;
          const date = new Date();
          date.setDate(date.getDate() + lead);
          document.getElementById('result').textContent =
            temp !== undefined
              ? `Temperature at (${lat}, ${lon}) on ${date.toDateString()}: ${temp} °C`
              : 'Data not available';
        })
        .catch(() => {
          document.getElementById('result').textContent = 'Error fetching data.';
        });
    }

    function downloadCSV() {
      let csv = "Latitude,Longitude,Temperature\n";
      for (let i = 0; i < lats.length; i++) {
        for (let j = 0; j < lons.length; j++) {
          const temp = z[i]?.[j];
          if (temp !== null && temp !== undefined) {
            csv += `${lats[i]},${lons[j]},${temp}\n`;
          }
        }
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `temperature_day${currentLead }.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    document.getElementById('leadDay').addEventListener('change', (e) => {
      fetchHeatmapData(parseInt(e.target.value));
    });

    // Initial load
    fetchHeatmapData(1);
  </script>
</body>
</html>

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Heat-Wave Predictor (Joshi 2025)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #header {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 2px 0;
      background-color: #e1f7d5;
      border-bottom: 3px solid #1f77b4;
    }
    #header h1 {
      font-size: 24px;
      font-weight: bold;
      color: #1f77b4;
    }
    #controls {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    label {
      font-weight: bold;
    }
    select, input, button {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #1f77b4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #155a8a;
    }
    #result {
      margin-top: 10px;
      font-weight: bold;
      color: #444;
    }
    #heatmap, #heatwave-probability {
      width: 100%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
    }
    #download-btn {
      margin-top: 15px;
    }
    #forecast-date {
      font-style: italic;
      margin-top: -10px;
    }
    #research-info {
      position: relative;
      width: 100%;
      background-color: #e1f7d5;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    @media (max-width: 600px) {
      #research-info {
        width: 100%;
        padding: 10px;
        font-size: 14px;
      }
    }
    #research-info h3 {
      margin-top: 0;
    }
    #research-info a {
      color: #1f77b4;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Heat-Wave Predictor by Yash Joshi</h1>
  </div>

  <div id="research-info">
    <h3 style="padding-left: 30px;">Research Paper</h3>
    <p style="padding-left: 30px;">This tool is based on the study <strong>"Prediction of regional heat waves using Hybrid LSTM approach"</strong> by Yash Joshi et al. (M.Tech Project, IIT Bhubaneswar under Dr. SR Kannan).</p>
    <p style="padding-left: 30px;">Read the paper: <a href="https://drive.google.com/file/d/1237mQWaa4qvh7VelEPUmZhDkiCLnXcII/view?usp=sharing" target="_blank">Research Link</a></p>
  </div>

  <br>

  <div id="controls">
    <div>
      <label for="leadDay">Select Day Lead:</label>
      <select id="leadDay">
        <option value="1">Day 1</option>
        <option value="2">Day 2</option>
        <option value="3">Day 3</option>
      </select>
    </div>
    <div>
      <label for="lat">Latitude:</label>
      <input type="number" id="lat" step="0.01" placeholder="e.g., 20.75">
    </div>
    <div>
      <label for="lon">Longitude:</label>
      <input type="number" id="lon" step="0.01" placeholder="e.g., 84.25">
    </div>
    <button onclick="fetchSinglePointTemp()">Get Temp at Point</button>
    <div id="result"></div>
  </div>

  <div id="forecast-date"></div>
<div id="loading-message" style="display: none; font-weight: bold; color: #1f77b4; margin-top: 10px;">
  Please wait, the model results are being loaded...
</div>
  <div id="heatmap"></div>
  <div id="heatwave-probability"></div>
  <button id="download-btn" onclick="downloadCSV()">Download CSV</button>

  <script>
    const latStart = 19.0, latEnd = 22.0;
    const lonStart = 82.0, lonEnd = 86.0;
    const step = 0.25;
    let lats = [], lons = [], z = [], probZ = [];
    let currentLead = 0;
    let spatialAvg = 0;

    for (let lat = latStart; lat <= latEnd; lat += step) {
      lats.push(parseFloat(lat.toFixed(2)));
    }
    for (let lon = lonStart; lon <= lonEnd; lon += step) {
      lons.push(parseFloat(lon.toFixed(2)));
    }

    function updateForecastDate(lead) {
      const today = new Date();
      today.setDate(today.getDate() + lead);  // ✅ Fixed here
      const forecastDate = today.toDateString();
      document.getElementById('forecast-date').textContent = `Forecast for: ${forecastDate}`;
    }

    function fetchHeatmapData(dayLead = 0) {
      currentLead = dayLead;
      updateForecastDate(dayLead);
      document.getElementById('loading-message').style.display = 'block';
  setTimeout(() => {
    document.getElementById('loading-message').style.display = 'none';
  }, 20000);
      z = [];
      probZ = [];
      let total = lats.length * lons.length;
      let completed = 0;
      let tempSum = 0, count = 0;

      lats.forEach((lat, i) => {
        z[i] = [];
        lons.forEach((lon, j) => {
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max&forecast_days=4&timezone=auto`;

          fetch(url)
            .then(res => res.json())
            .then(data => {
              const temp = data.daily?.temperature_2m_max?.[dayLead] ?? null;
              z[i][j] = temp;

              if (temp !== null) {
                tempSum += temp;
                count++;
              }
            })
            .catch(() => {
              z[i][j] = null;
            })
            .finally(() => {
              completed++;
              if (completed === total) {
                spatialAvg = tempSum / count;
                computeProbabilityMap();
                renderHeatmap();
                renderProbabilityContour();
              }
            });
        });
      });
    }

    function computeProbabilityMap() {
      probZ = [];
      for (let i = 0; i < lats.length; i++) {
        probZ[i] = [];
        for (let j = 0; j < lons.length; j++) {
          const temp = z[i][j];
          if (temp !== null) {
            const deviation = temp - spatialAvg;
            const prob = 1 / (1 + Math.exp(-0.3 * deviation));
            probZ[i][j] = Math.round(prob * 100);
          } else {
            probZ[i][j] = null;
          }
        }
      }
    }

    function renderHeatmap() {
      const data = [{
        z: z,
        x: lons,
        y: lats,
        type: 'heatmap',
        zsmooth: 'best',
        colorscale: 'YlOrRd',
        reversescale: true,
        colorbar: { title: '°C' }
      }];

      const layout = {
        xaxis: { title: 'Longitude' },
        yaxis: { title: 'Latitude' },
        title: 'Max Temperature Forecast'
      };

      Plotly.newPlot('heatmap', data, layout);
    }

    function renderProbabilityContour() {
      const data = [{
        z: probZ,
        x: lons,
        y: lats,
        type: 'contour',
        colorscale: 'Reds',
        contours: {
          coloring: 'heatmap',
          showlabels: true,
          labelfont: { size: 12, color: 'black' }
        },
        colorbar: { title: 'Probability (%)' }
      }];

      const layout = {
        xaxis: { title: 'Longitude' },
        yaxis: { title: 'Latitude' },
        title: 'Heatwave Probability (Deviation > 4.5°C)'
      };

      Plotly.newPlot('heatwave-probability', data, layout);
    }

    function fetchSinglePointTemp() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const lead = parseInt(document.getElementById('leadDay').value);

      if (isNaN(lat) || isNaN(lon)) {
        document.getElementById('result').textContent = 'Please enter valid coordinates.';
        return;
      }

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max&forecast_days=4&timezone=auto`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const temp = data.daily?.temperature_2m_max?.[lead];
          const date = new Date();
          date.setDate(date.getDate() + lead);  // ✅ Fixed here
          document.getElementById('result').textContent =
            temp !== undefined
              ? `Temperature at (${lat}, ${lon}) on ${date.toDateString()}: ${temp} °C`
              : 'Data not available';
        })
        .catch(() => {
          document.getElementById('result').textContent = 'Error fetching data.';
        });
    }

    function downloadCSV() {
      let csv = "Latitude,Longitude,Temperature\n";
      for (let i = 0; i < lats.length; i++) {
        for (let j = 0; j < lons.length; j++) {
          const temp = z[i]?.[j];
          if (temp !== null && temp !== undefined) {
            csv += `${lats[i]},${lons[j]},${temp}\n`;
          }
        }
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `temperature_day${currentLead + 1}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    document.getElementById('leadDay').addEventListener('change', (e) => {
      fetchHeatmapData(parseInt(e.target.value));
    });

    // Initial load
    fetchHeatmapData(1);
  </script>
</body>
</html> -->
<!--  <!DOCTYPE html>
<html>
<head>
  <title>Heat-Wave Predictor (Joshi 2025)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #header {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 2px 0;
      background-color: #e1f7d5;
      border-bottom: 3px solid #1f77b4;
    }
    #header h1 {
      font-size: 24px;
      font-weight: bold;
      color: #1f77b4;
    }
    #controls {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    label {
      font-weight: bold;
    }
    select, input, button {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #1f77b4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #155a8a;
    }
    #result {
      margin-top: 10px;
      font-weight: bold;
      color: #444;
    }
    #heatmap, #heatwave-probability {
      width: 100%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
    }
    #download-btn {
      margin-top: 15px;
    }
    #forecast-date {
      font-style: italic;
      margin-top: -10px;
    }
    
    #research-info {
  position: relative; /* Change from fixed position */
  width: 100%;
  background-color: #e1f7d5;
  padding: 15px 15px 15px 15px;
 ;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px; /* Add space below it */
}

@media (max-width: 600px) {
  #research-info {
    width: 100%;
    padding: 10px;
    font-size: 14px;
  }
}
    #research-info h3 {
      margin-top: 0;
    }
    #research-info a {
      color: #1f77b4;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Heat-Wave Predictor by Yash Joshi</h1>
  </div>

  <div id="research-info">
    <h3 style="padding-left: 30px;">Research Paper</h3>
    <p style="padding-left: 30px;">This tool is based on the study <strong>"Prediction of regional heat waves using Hybrid LSTM approach"</strong> by Yash Joshi et al. (M.Tech Project, IIT Bhubaneswar under Dr. SR Kannan).</p>
    <p style="padding-left: 30px;">Read the paper: <a href="https://drive.google.com/file/d/1237mQWaa4qvh7VelEPUmZhDkiCLnXcII/view?usp=sharing" target="_blank">Research Link</a></p>
  </div>
<br>
  <div id="controls">
    <div>
      <label for="leadDay">Select Day Lead:</label>
      <select id="leadDay">
        <option value="1">Day 1</option>
        <option value="2">Day 2</option>
        <option value="3">Day 3</option>
      </select>
    </div>
    <div>
      <label for="lat">Latitude:</label>
      <input type="number" id="lat" step="0.01" placeholder="e.g., 20.75">
    </div>
    <div>
      <label for="lon">Longitude:</label>
      <input type="number" id="lon" step="0.01" placeholder="e.g., 84.25">
    </div>
    <button onclick="fetchSinglePointTemp()">Get Temp at Point</button>
    <div id="result"></div>
  </div>

  <div id="forecast-date"></div>

  <div id="heatmap"></div>
  <div id="heatwave-probability"></div>
  <button id="download-btn" onclick="downloadCSV()">Download CSV</button>

  <script>
    const latStart = 19.0, latEnd = 22.0;
    const lonStart = 82.0, lonEnd = 86.0;
    const step = 0.25;
    let lats = [], lons = [], z = [], probZ = [];
    let currentLead = 0;
    let spatialAvg = 0;

    for (let lat = latStart; lat <= latEnd; lat += step) {
      lats.push(parseFloat(lat.toFixed(2)));
    }
    for (let lon = lonStart; lon <= lonEnd; lon += step) {
      lons.push(parseFloat(lon.toFixed(2)));
    }

    function updateForecastDate(lead) {
      const today = new Date();
      today.setDate(today.getDate() + lead + 1); // Lead 0 => tomorrow
      const forecastDate = today.toDateString();
      document.getElementById('forecast-date').textContent = `Forecast for: ${forecastDate}`;
    }

    function fetchHeatmapData(dayLead = 0) {
      currentLead = dayLead;
      updateForecastDate(dayLead);

      z = [];
      probZ = [];
      let total = lats.length * lons.length;
      let completed = 0;
      let tempSum = 0, count = 0;

      lats.forEach((lat, i) => {
        z[i] = [];
        lons.forEach((lon, j) => {
           const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max&forecast_days=3&timezone=auto`;
           //const url = `https://backend-heatwave.onrender.com/api/forecast?lat=${lat}&lon=${lon}&days=3`;

          fetch(url)
            .then(res => res.json())
            .then(data => {
              const temp = data.daily?.temperature_2m_max?.[dayLead] ?? null;
              z[i][j] = temp;

              if (temp !== null) {
                tempSum += temp;
                count++;
              }
            })
            .catch(() => {
              z[i][j] = null;
            })
            .finally(() => {
              completed++;
              if (completed === total) {
                spatialAvg = tempSum / count;
                computeProbabilityMap();
                renderHeatmap();
                renderProbabilityContour();
              }
            });
        });
      });
    }

    function computeProbabilityMap() {
      probZ = [];
      for (let i = 0; i < lats.length; i++) {
        probZ[i] = [];
        for (let j = 0; j < lons.length; j++) {
          const temp = z[i][j];
          if (temp !== null) {
            const deviation = temp - spatialAvg;
            const prob = 1 / (1 + Math.exp(-0.3 * (deviation )));
            probZ[i][j] = Math.round(prob * 100); // percentage
          } else {
            probZ[i][j] = null;
          }
        }
      }
    }

    function renderHeatmap() {
      const data = [{
        z: z,
        x: lons,
        y: lats,
        type: 'heatmap',
        zsmooth: 'best',
        colorscale: 'YlOrRd',
        reversescale: true,
        colorbar: { title: '°C' }
      }];

      const layout = {
        xaxis: { title: 'Longitude' },
        yaxis: { title: 'Latitude' },
        title: 'Max Temperature Forecast'
      };

      Plotly.newPlot('heatmap', data, layout);
    }

    function renderProbabilityContour() {
      const data = [{
        z: probZ,
        x: lons,
        y: lats,
        type: 'contour',
        colorscale: 'Reds',
        contours: {
          coloring: 'heatmap',
          showlabels: true,
          labelfont: { size: 12, color: 'black' }
        },
        colorbar: { title: 'Probability (%)' }
      }];

      const layout = {
        xaxis: { title: 'Longitude' },
        yaxis: { title: 'Latitude' },
        title: 'Heatwave Probability (Deviation > 4.5°C)'
      };

      Plotly.newPlot('heatwave-probability', data, layout);
    }

    function fetchSinglePointTemp() {
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const lead = parseInt(document.getElementById('leadDay').value);

      if (isNaN(lat) || isNaN(lon)) {
        document.getElementById('result').textContent = 'Please enter valid coordinates.';
        return;
      }

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max&forecast_days=3&timezone=auto`;
      // const url = `https://backend-heatwave.onrender.com/api/forecast?lat=${lat}&lon=${lon}&days=3`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const temp = data.daily?.temperature_2m_max?.[lead];
          const date = new Date();
          date.setDate(date.getDate() + lead + 1);
          document.getElementById('result').textContent =
            temp !== undefined
              ? `Temperature at (${lat}, ${lon}) on ${date.toDateString()}: ${temp} °C`
              : 'Data not available';
        })
        .catch(() => {
          document.getElementById('result').textContent = 'Error fetching data.';
        });
    }

    function downloadCSV() {
      let csv = "Latitude,Longitude,Temperature\n";
      for (let i = 0; i < lats.length; i++) {
        for (let j = 0; j < lons.length; j++) {
          const temp = z[i]?.[j];
          if (temp !== null && temp !== undefined) {
            csv += `${lats[i]},${lons[j]},${temp}\n`;
          }
        }
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `temperature_day${currentLead + 1}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    document.getElementById('leadDay').addEventListener('change', (e) => {
      fetchHeatmapData(parseInt(e.target.value));
    });

    // Initial load
    fetchHeatmapData(0);
  </script>
</body>
</html> -->
<!-- <!DOCTYPE html>
 <html>
 <head>
   <title>Heat-Wave Predictor (Joshi 2025)</title>
   <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
   <style>
     body {
       font-family: 'Segoe UI', sans-serif;
       margin: 0;
       padding: 0;
       background-color: #f9f9f9;
       color: #333;
       display: flex;
       flex-direction: column;
       align-items: center;
     }
     #header {
       width: 100%;
       display: flex;
       justify-content: center;
       align-items: center;
       gap: 20px;
       padding: 2px 0;
       background-color: #e1f7d5;
       border-bottom: 3px solid #1f77b4;
     }
     #header h1 {
       font-size: 24px;
       font-weight: bold;
       color: #1f77b4;
     }
     #controls {
       margin-bottom: 20px;
       display: flex;
       gap: 20px;
       align-items: center;
       flex-wrap: wrap;
     }
     label {
       font-weight: bold;
     }
     select, input, button {
       padding: 6px 10px;
       font-size: 14px;
       border: 1px solid #ccc;
       border-radius: 5px;
     }
     button {
       background-color: #1f77b4;
       color: white;
       cursor: pointer;
     }
     button:hover {
       background-color: #155a8a;
     }
     #result {
       margin-top: 10px;
       font-weight: bold;
       color: #444;
     }
     #heatmap, #heatwave-probability {
       width: 100%;
       max-width: 900px;
       height: 600px;
       border: 1px solid #ddd;
       border-radius: 10px;
       overflow: hidden;
       margin-top: 20px;
     }
     #download-btn {
       margin-top: 15px;
     }
     #forecast-date {
       font-style: italic;
       margin-top: -10px;
     }
     
     #research-info {
       position: relative;
       width: 100%;
       background-color: #e1f7d5;
       padding: 15px 15px 15px 15px;
       border-radius: 10px;
       box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
       margin-bottom: 20px;
     }
 
     @media (max-width: 600px) {
       #research-info {
         width: 100%;
         padding: 10px;
         font-size: 14px;
       }
     }
     #research-info h3 {
       margin-top: 0;
     }
     #research-info a {
       color: #1f77b4;
     }
   </style>
 </head>
 <body>
   <div id="header">
     <h1>Heat-Wave Predictor by Yash Joshi</h1>
   </div>
 
   <div id="research-info">
     <h3 style="padding-left: 30px;">Research Paper</h3>
     <p style="padding-left: 30px;">This tool is based on the study <strong>"Prediction of regional heat waves using Hybrid LSTM approach"</strong> by Yash Joshi et al. (M.Tech Project, IIT Bhubaneswar under Dr. SR Kannan).</p>
     <p style="padding-left: 30px;">Read the paper: <a href="https://drive.google.com/file/d/1237mQWaa4qvh7VelEPUmZhDkiCLnXcII/view?usp=sharing" target="_blank">Research Link</a></p>
   </div>
 <br>
   <div id="controls">
     <div>
       <label for="leadDay">Select Day Lead:</label>
       <select id="leadDay">
         <option value="1">Day 1</option>
         <option value="2">Day 2</option>
         <option value="3">Day 3</option>
       </select>
     </div>
     <div>
       <label for="lat">Latitude:</label>
       <input type="number" id="lat" step="0.01" placeholder="e.g., 20.75">
     </div>
     <div>
       <label for="lon">Longitude:</label>
       <input type="number" id="lon" step="0.01" placeholder="e.g., 84.25">
     </div>
     <button onclick="fetchSinglePointTemp()">Get Temp at Point</button>
     <div id="result"></div>
   </div>
 
   <div id="forecast-date"></div>
 
   <div id="heatmap"></div>
   <div id="heatwave-probability"></div>
   <button id="download-btn" onclick="downloadCSV()">Download CSV</button>
 
   <script>
     const latStart = 19.0, latEnd = 22.0;
     const lonStart = 82.0, lonEnd = 86.0;
     const step = 0.25;
     let lats = [], lons = [], z = [], probZ = [];
     let currentLead = 0;
     let spatialAvg = 0;
 
     for (let lat = latStart; lat <= latEnd; lat += step) {
       lats.push(parseFloat(lat.toFixed(2)));
     }
     for (let lon = lonStart; lon <= lonEnd; lon += step) {
       lons.push(parseFloat(lon.toFixed(2)));
     }
 
     function updateForecastDate(lead) {
       const today = new Date();
       today.setDate(today.getDate() + lead + 1); // Lead 0 => tomorrow
       const forecastDate = today.toDateString();
       document.getElementById('forecast-date').textContent = `Forecast for: ${forecastDate}`;
     }
 
     function fetchHeatmapData(dayLead = 0) {
       currentLead = dayLead;
       updateForecastDate(dayLead);
 
       z = [];
       probZ = [];
       let total = lats.length * lons.length;
       let completed = 0;
       let tempSum = 0, count = 0;
 
       lats.forEach((lat, i) => {
         z[i] = [];
         lons.forEach((lon, j) => {
           const url = `https://backend-heatwave.onrender.com/api/forecast?lat=${lat}&lon=${lon}&days=3`;
 
           fetch(url)
             .then(res => res.json())
             .then(data => {
               const temp = data.daily?.temperature_2m_max?.[dayLead] ?? null;
               z[i][j] = temp;
 
               if (temp !== null) {
                 tempSum += temp;
                 count++;
               }
             })
             .catch(() => {
               z[i][j] = null;
             })
             .finally(() => {
               completed++;
               if (completed === total) {
                 spatialAvg = tempSum / count;
                 interpolateMissingValues();
                 computeProbabilityMap();
                 renderHeatmap();
                 renderProbabilityContour();
               }
             });
         });
       });
     }
 
     function interpolateMissingValues() {
       for (let i = 0; i < z.length; i++) {
         for (let j = 0; j < z[i].length; j++) {
           if (z[i][j] === null) {
             let neighbors = [];
             // Collect neighbors (left, right, top, bottom)
             if (i > 0 && z[i - 1][j] !== null) neighbors.push(z[i - 1][j]); // top
             if (i < z.length - 1 && z[i + 1][j] !== null) neighbors.push(z[i + 1][j]); // bottom
             if (j > 0 && z[i][j - 1] !== null) neighbors.push(z[i][j - 1]); // left
             if (j < z[i].length - 1 && z[i][j + 1] !== null) neighbors.push(z[i][j + 1]); // right
             
             if (neighbors.length > 0) {
               z[i][j] = neighbors.reduce((a, b) => a + b, 0) / neighbors.length; // average of neighbors
             }
           }
         }
       }
     }
 
     function computeProbabilityMap() {
       probZ = [];
       for (let i = 0; i < lats.length; i++) {
         probZ[i] = [];
         for (let j = 0; j < lons.length; j++) {
           const temp = z[i][j];
           if (temp !== null) {
             const deviation = temp - spatialAvg;
             const prob = 1 / (1 + Math.exp(-0.3 * (deviation )));
             probZ[i][j] = Math.round(prob * 100); // percentage
           } else {
             probZ[i][j] = null;
           }
         }
       }
     }
 
     function renderHeatmap() {
       const data = [{
         z: z,
         x: lons,
         y: lats,
         type: 'heatmap',
         zsmooth: 'best',
         colorscale: 'YlOrRd',
         reversescale: true,
         colorbar: { title: '°C' }
       }];
 
       const layout = {
         xaxis: { title: 'Longitude' },
         yaxis: { title: 'Latitude' },
         title: 'Max Temperature Forecast'
       };
 
       Plotly.newPlot('heatmap', data, layout);
     }
 
     function renderProbabilityContour() {
       const data = [{
         z: probZ,
         x: lons,
         y: lats,
         type: 'contour',
         colorscale: 'Reds',
         contours: {
           coloring: 'heatmap',
           showlabels: true,
           labelfont: { size: 12, color: 'black' }
         },
         colorbar: { title: 'Probability (%)' }
       }];
 
       const layout = {
         xaxis: { title: 'Longitude' },
         yaxis: { title: 'Latitude' },
         title: 'Heatwave Probability (Deviation > 4.5°C)'
       };
 
       Plotly.newPlot('heatwave-probability', data, layout);
     }
 
     function fetchSinglePointTemp() {
       const lat = parseFloat(document.getElementById('lat').value);
       const lon = parseFloat(document.getElementById('lon').value);
       const lead = parseInt(document.getElementById('leadDay').value);
 
       if (isNaN(lat) || isNaN(lon)) {
         document.getElementById('result').textContent = 'Please enter valid coordinates.';
         return;
       }
 
       const url = `https://backend-heatwave.onrender.com/api/forecast?lat=${lat}&lon=${lon}&days=3`;
 
       fetch(url)
         .then(res => res.json())
         .then(data => {
           const temp = data.daily?.temperature_2m_max?.[lead];
           const date = new Date();
           date.setDate(date.getDate() + lead + 1);
           document.getElementById('result').textContent =
             temp !== undefined
               ? `Temperature at (${lat}, ${lon}) on ${date.toDateString()}: ${temp} °C`
               : 'Data not available';
         })
         .catch(() => {
           document.getElementById('result').textContent = 'Error fetching data.';
         });
     }
 
     function downloadCSV() {
       let csv = "Latitude,Longitude,Temperature\n";
       for (let i = 0; i < lats.length; i++) {
         for (let j = 0; j < lons.length; j++) {
           const temp = z[i]?.[j];
           if (temp !== null && temp !== undefined) {
             csv += `${lats[i]},${lons[j]},${temp}\n`;
           }
         }
       }
       const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
       const url = URL.createObjectURL(blob);
       const a = document.createElement("a");
       a.href = url;
       a.download = `temperature_day${currentLead + 1}.csv`;
       document.body.appendChild(a);
       a.click();
       document.body.removeChild(a);
     }
 
     document.getElementById('leadDay').addEventListener('change', (e) => {
       fetchHeatmapData(parseInt(e.target.value));
     });
 
     // Initial load
     fetchHeatmapData(0);
   </script>
 </body>
 </html> -->



